<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  
  

  
  
  

  
  
  

  

  
  

  
  
  
  
  
  
  
  

  <!-- Primary Meta Tags -->
  <title>将已有 Linux 系统做成 img 镜像 闻道</title>
  <meta name="title" content="将已有 Linux 系统做成 img 镜像 闻道" />
  <meta name="description" content="" />

  <!-- Open Graph / Facebook -->
  <meta property="og:site_name" content="将已有 Linux 系统做成 img 镜像 闻道" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="/blog/linux/001" />
  <meta property="og:title" content="将已有 Linux 系统做成 img 镜像 闻道" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="/assets/img/header.png" />

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="/blog/linux/001" />
  <meta property="twitter:title" content="将已有 Linux 系统做成 img 镜像 闻道" />
  <meta property="twitter:description" content="" />
  <meta property="twitter:image" content="/assets/img/header.png" />
  
  <meta property="twitter:creator" content="@zcteo" />
  <meta property="twitter:site" content="@zcteo" />
  

  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="canonical" href="/blog/linux/001" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />

  


<!-- 百度统计 -->
<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?62e91d20eba5a638ec237f1451dc45c1";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- 不蒜子统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <base target="_blank" />
</head>


<body>
  <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/" target="_self">
      <img src="/assets/img/title.png" alt="闻道" />
    </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon" target="_self"></a>

      <div class="menu">
        
        
        
        <a class="page-link" href="/" target="_self">
          Home
        </a>
        
        
        
        <a class="page-link" href="/blog" target="_self">
          Blog
        </a>
        
        
        
        <a class="page-link" href="/about" target="_self">
          About
        </a>
        
      </div>
    </nav>
  </div>
</header>


  <div class="page-content">
    <div class="wrapper">
      <article class="post-content">
        <h1 id="将已有-linux-系统做成-img-镜像">将已有 Linux 系统做成 img 镜像</h1>

<p>[TOC]</p>

<h2 id="准备工作">准备工作</h2>

<p>挂载 SD 卡</p>

<p>查看 SD 卡磁盘情况</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>fdisk <span class="nt">-l</span> 
</code></pre></div></div>

<p>找到 SD 卡信息</p>

<p><img src="img\001\01.png" alt="01" /></p>

<p>建立挂载点</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /mnt/boot
<span class="nb">sudo mkdir</span> /mnt/rootfs
</code></pre></div></div>

<p>挂载</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mount /dev/sdc1 /mnt/boot/
<span class="nb">sudo </span>mount /dev/sdc2 /mnt/rootfs/
</code></pre></div></div>

<p>查看根文件系统占用大小</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">df</span> <span class="nt">-h</span>
</code></pre></div></div>

<p><img src="img/001/02.png" alt="02" /></p>

<p>生成空白 img 文件；文件稍微比两个分区占用大一些；这里就搞成 4GB</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dd </span><span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>sys.img <span class="nv">bs</span><span class="o">=</span>4M <span class="nv">count</span><span class="o">=</span>1024
<span class="c"># 完成后输出如下</span>
1024+0 records <span class="k">in
</span>1024+0 records out
4294967296 bytes <span class="o">(</span>4.3 GB, 4.0 GiB<span class="o">)</span> copied, 21.4173 s, 201 MB/s
</code></pre></div></div>

<h2 id="空白-img-文件分区">空白 img 文件分区</h2>

<h3 id="将-img-文件和-loop-设备建立联系">将 img 文件和 loop 设备建立联系</h3>

<p>先查看当前loop设备</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>losetup <span class="nt">-l</span>
</code></pre></div></div>

<p><img src="img/001/03.png" alt="03" /></p>

<p>因为 loop 设备已经到 5 了，所以将 img 文件和 loop6 设备建立联系</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>losetup /dev/loop6 sys.img
</code></pre></div></div>

<p>查看是否成功</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>losetup <span class="nt">-l</span>
</code></pre></div></div>

<p><img src="img/001/04.png" alt="04" /></p>

<h3 id="使用-fdisk-分区">使用 fdisk 分区</h3>

<ol>
  <li>输入 m 获取帮助</li>
  <li>输入 n 创建新分区（BOOT）</li>
  <li>输入 p 或者默认表示创建主分区</li>
  <li>分区号（1）和起始扇区直接默认回车</li>
  <li>终止扇区输入 <code class="highlighter-rouge">+200M</code> 表示创建 200M 的分区供 BOOT 使用</li>
  <li>输入 t 改变分区类型</li>
  <li>选择分区 1</li>
  <li>输入 L 查看所有分区类型码表</li>
  <li>输入 b 表示转换为 fat32</li>
  <li>输入 n 创建新分区（rootfs）</li>
  <li>一路回车直至创建分区成功</li>
  <li>输入 a 标记引导分区</li>
  <li>输入 1 将分区 1 标记为可引导</li>
  <li>输入 w 保存更改</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>fdisk /dev/loop6
</code></pre></div></div>

<p>详细输出如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Welcome to fdisk (util-linux 2.34).
Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table.
Created a new DOS disklabel with disk identifier 0x71f6c888.

Command (m for help): m

Help:

  DOS (MBR)
   a   toggle a bootable flag
   b   edit nested BSD disklabel
   c   toggle the dos compatibility flag

  Generic
   d   delete a partition
   F   list free unpartitioned space
   l   list known partition types
   n   add a new partition
   p   print the partition table
   t   change a partition type
   v   verify the partition table
   i   print information about a partition

  Misc
   m   print this menu
   u   change display/entry units
   x   extra functionality (experts only)

  Script
   I   load disk layout from sfdisk script file
   O   dump disk layout to sfdisk script file

  Save &amp; Exit
   w   write table to disk and exit
   q   quit without saving changes

  Create a new label
   g   create a new empty GPT partition table
   G   create a new empty SGI (IRIX) partition table
   o   create a new empty DOS partition table
   s   create a new empty Sun partition table


Command (m for help): n
Partition type
   p   primary (0 primary, 0 extended, 4 free)
   e   extended (container for logical partitions)
Select (default p): 

Using default response p.
Partition number (1-4, default 1): 
First sector (2048-8388607, default 2048): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (2048-8388607, default 8388607): +200M

Created a new partition 1 of type 'Linux' and of size 200 MiB.

Command (m for help): t
Selected partition 1
Hex code (type L to list all codes): L

 0  Empty           24  NEC DOS         81  Minix / old Lin bf  Solaris        
 1  FAT12           27  Hidden NTFS Win 82  Linux swap / So c1  DRDOS/sec (FAT-
 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-
 3  XENIX usr       3c  PartitionMagic  84  OS/2 hidden or  c6  DRDOS/sec (FAT-
 4  FAT16 &lt;32M      40  Venix 80286     85  Linux extended  c7  Syrinx         
 5  Extended        41  PPC PReP Boot   86  NTFS volume set da  Non-FS data    
 6  FAT16           42  SFS             87  NTFS volume set db  CP/M / CTOS / .
 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux plaintext de  Dell Utility   
 8  AIX             4e  QNX4.x 2nd part 8e  Linux LVM       df  BootIt         
 9  AIX bootable    4f  QNX4.x 3rd part 93  Amoeba          e1  DOS access     
 a  OS/2 Boot Manag 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O        
 b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor      
 c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad hi ea  Rufus alignment
 e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         eb  BeOS fs        
 f  W95 Ext'd (LBA) 54  OnTrackDM6      a6  OpenBSD         ee  GPT            
10  OPUS            55  EZ-Drive        a7  NeXTSTEP        ef  EFI (FAT-12/16/
11  Hidden FAT12    56  Golden Bow      a8  Darwin UFS      f0  Linux/PA-RISC b
12  Compaq diagnost 5c  Priam Edisk     a9  NetBSD          f1  SpeedStor      
14  Hidden FAT16 &lt;3 61  SpeedStor       ab  Darwin boot     f4  SpeedStor      
16  Hidden FAT16    63  GNU HURD or Sys af  HFS / HFS+      f2  DOS secondary  
17  Hidden HPFS/NTF 64  Novell Netware  b7  BSDI fs         fb  VMware VMFS    
18  AST SmartSleep  65  Novell Netware  b8  BSDI swap       fc  VMware VMKCORE 
1b  Hidden W95 FAT3 70  DiskSecure Mult bb  Boot Wizard hid fd  Linux raid auto
1c  Hidden W95 FAT3 75  PC/IX           bc  Acronis FAT32 L fe  LANstep        
1e  Hidden W95 FAT1 80  Old Minix       be  Solaris boot    ff  BBT            
Hex code (type L to list all codes): b
Changed type of partition 'Linux' to 'W95 FAT32'.

Command (m for help): n
Partition type
   p   primary (1 primary, 0 extended, 3 free)
   e   extended (container for logical partitions)
Select (default p): p
Partition number (2-4, default 2): 
First sector (411648-8388607, default 411648): 
Last sector, +/-sectors or +/-size{K,M,G,T,P} (411648-8388607, default 8388607): 

Created a new partition 2 of type 'Linux' and of size 3.8 GiB.

Command (m for help): a
Partition number (1,2, default 2): 1

The bootable flag on partition 1 is enabled now.

Command (m for help): w
The partition table has been altered.
Calling ioctl() to re-read partition table.
Re-reading the partition table failed.: Invalid argument

The kernel still uses the old table. The new table will be used at the next reboot or after you run partprobe(8) or kpartx(8).
</code></pre></div></div>

<p>断开 img 文件和 loop 设备建立联系</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>losetup <span class="nt">-d</span> /dev/loop6
<span class="c"># 检查操作是否成功</span>
<span class="nb">sudo </span>losetup <span class="nt">-l</span>
<span class="c"># 输出</span>
NAME       SIZELIMIT OFFSET AUTOCLEAR RO BACK-FILE                                        DIO LOG-SEC
/dev/loop1         0      0         1  1 /var/lib/snapd/snaps/gnome-3-34-1804_24.snap       0     512
/dev/loop4         0      0         1  1 /var/lib/snapd/snaps/snapd_10707.snap              0     512
/dev/loop2         0      0         1  1 /var/lib/snapd/snaps/gtk-common-themes_1506.snap   0     512
/dev/loop0         0      0         1  1 /var/lib/snapd/snaps/core18_1705.snap              0     512
/dev/loop5         0      0         1  1 /var/lib/snapd/snaps/snapd_7264.snap               0     512
/dev/loop3         0      0         1  1 /var/lib/snapd/snaps/snap-store_433.snap           0     51
</code></pre></div></div>

<h3 id="将分区和-loop设备建立联系">将分区和 loop设备建立联系</h3>

<p>查看 img 文件分区情况</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fdisk <span class="nt">-l</span> sys.img
</code></pre></div></div>

<p>可以看到扇区大小为 512 bytes；并记录下各分区起止扇区编号</p>

<p><img src="img/001/05.png" alt="05" /></p>

<p>将分区和 loop设备建立联系</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># -o （起始扇区 * 扇区大小）--sizelimit （扇区数量 * 扇区大小）</span>
<span class="nb">sudo </span>losetup <span class="nt">-f</span> <span class="nt">-o</span> 1048576 <span class="nt">--sizelimit</span> 209715200 sys.img 
<span class="nb">sudo </span>losetup <span class="nt">-f</span> <span class="nt">-o</span> 210763776 <span class="nt">--sizelimit</span> 4084203520 sys.img 
</code></pre></div></div>

<p><em>1048576 = 2048 * 512 ； 209715200 = 409600 * 512 或 （411647 - 2048 + 1）* 512 （注意： +1）</em></p>

<p>查看是否成功</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>losetup <span class="nt">-l</span>
<span class="c"># 输出</span>
NAME        SIZELIMIT    OFFSET AUTOCLEAR RO BACK-FILE                                        DIO LOG-SEC
/dev/loop1          0         0         1  1 /var/lib/snapd/snaps/gnome-3-34-1804_24.snap       0     512
/dev/loop6  209715200   1048576         0  0 /home/zzc/Documents/sys.img                        0     512
/dev/loop4          0         0         1  1 /var/lib/snapd/snaps/snapd_10707.snap              0     512
/dev/loop2          0         0         1  1 /var/lib/snapd/snaps/gtk-common-themes_1506.snap   0     512
/dev/loop0          0         0         1  1 /var/lib/snapd/snaps/core18_1705.snap              0     512
/dev/loop7 4084203520 210763776         0  0 /home/zzc/Documents/sys.img                        0     512
/dev/loop5          0         0         1  1 /var/lib/snapd/snaps/snapd_7264.snap               0     512
/dev/loop3          0         0         1  1 /var/lib/snapd/snaps/snap-store_433.snap           0     512
</code></pre></div></div>

<h3 id="格式化分区">格式化分区</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mkfs.fat /dev/loop6
<span class="nb">sudo </span>mkfs.ext4 /dev/loop7
</code></pre></div></div>

<p><img src="img/001/06.png" alt="06" /></p>

<h3 id="挂载分区">挂载分区</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 建立挂载点</span>
<span class="nb">mkdir </span>rootfs boot
<span class="c"># 挂载</span>
<span class="nb">sudo </span>mount /dev/loop6 boot/
<span class="nb">sudo </span>mount /dev/loop7 rootfs/
</code></pre></div></div>

<h2 id="拷贝原有文件到-img">拷贝原有文件到 img</h2>

<p>拷贝两个分区的文件</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cp</span> <span class="nt">-a</span> /mnt/boot/<span class="k">*</span> ./boot/
<span class="nb">sudo cp</span> <span class="nt">-a</span> /mnt/rootfs/<span class="k">*</span> ./rootfs/
</code></pre></div></div>

<p>拷贝完成后做一下清理工作</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>umount rootfs boot 
<span class="nb">sudo </span>losetup <span class="nt">-d</span> /dev/loop6 /dev/loop7
</code></pre></div></div>

<h2 id="修改卷标可选">修改卷标（可选）</h2>

<p>ext 文件系统</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>e2label /dev/<span class="nv">$partition</span> name
</code></pre></div></div>

<p>fat 文件系统</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>mlabel <span class="nt">-i</span> /dev/<span class="nv">$partition</span> ::name
</code></pre></div></div>

      </article>
      <div>
        <hr style="margin-top: 44px; margin-bottom: 18px;">
        <p><em>由于个人水平有限，文中若有不合理或不正确的地方欢迎指出改正</em></p>
      </div>
    </div>
    <!-- 生成目录 -->
    <script type="text/javascript" src="/assets/js/article.js"></script>
    <!-- valine 评论系统 -->
    
    <div id="valineComments" class="wrapper" style="margin-top: 44px; margin-bottom: 22px"></div>
    <script src='//unpkg.com/valine/dist/Valine.min.js'></script>
    <script>
      new Valine({
        el: '#valineComments',
        appId: 'ppzr2mzCo7as90WoayQJL7Pl-MdYXbMMI',
        appKey: 'N1Yw0XM7bvh2gGQFShapFEQN',
        placeholder: '欢迎提出您的宝贵意见，正确填写邮箱地址可收到邮件提醒',
        serverURLs: 'https://ppzr2mzc.api.lncldglobal.com',
        avatar: 'robohash',
        enableQQ: true,
        requiredFields: ['nick']
      })
    </script>
    
  </div>

  <footer class="site-footer">
  <div class="wrapper">
    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <h4>CONTACT</h4>

        <div class="social-links">
          
          <div class="social-link contact-links">

            
            <img src="/assets/img/icons/email.png" alt="email" />

            <a href="mailto:zcteo.cn@gmail.com" id="email-link"
               target="_self" >
              
              zcteo.cn@gmail.com
              
            </a>
          </div>

          
          <div class="social-link contact-links">

            
            <img src="/assets/img/icons/wechat.png" alt="wechat" />

            <a href="#" id="wechat-link"
               target="_self" >
              
              EricTeo-
              
            </a>
          </div>

          
          <div class="social-link contact-links">

            
            <img src="/assets/img/icons/telegram.png" alt="telegram" />

            <a href="https://t.me/zcteo6" id="telegram-link"
               target="_self" >
              
              Telegram
              
            </a>
          </div>

          
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <h4>FOLLOW</h4>

        <div class="social-links follow-links">
          
          <div class="social-link">

            
            <img src="/assets/img/icons/github.png" alt="github" />
            <a href="https://github.com/zcteo">
              
              GitHub
              
            </a>
          </div>

          
          <div class="social-link">

            
            <img src="/assets/img/icons/weibo.png" alt="weibo" />
            <a href="https://weibo.com/u/6664803739">
              
              WeiBo
              
            </a>
          </div>

          
          <div class="social-link">

            
            <img src="/assets/img/icons/twitter.png" alt="twitter" />
            <a href="https://twitter.com/zcteo">
              
              Twitter
              
            </a>
          </div>

          
          <div class="social-link">

            
            <img src="/assets/img/icons/facebook.png" alt="facebook" />
            <a href="https://facebook.com/zcteo">
              
              Facebook
              
            </a>
          </div>

          
          <div class="social-link">

            
            <img src="/assets/img/icons/csdn.png" alt="csdn" />
            <a href="https://blog.csdn.net/zcteo">
              
              CSDN
              
            </a>
          </div>

          
          <div class="social-link">

            
            <img src="/assets/img/icons/jianshu.png" alt="jianshu" />
            <a href="https://www.jianshu.com/u/031f77f21bd3">
              
              JianShu
              
            </a>
          </div>

          
        </div>
      </div>

      
    </div>

    
    <p class="footer-col" id="busuanzi_container_site_pv" style="display:none">
      本站总访问量 <span id="busuanzi_value_site_pv"></span> 次，本站访客数 <span id="busuanzi_value_site_uv"></span> 人次
      
      ，本文总阅读量 <span id="busuanzi_value_page_pv"></span> 次
      
    </p>

    <script>
      var id = setInterval(fixCount, 100)
      var site_pv = parseInt('100000')
      var site_uv = parseInt('10000')
      var page_pv = parseInt('1000')
      function fixCount() {
        if ($("#busuanzi_container_site_pv").css("display") != "none") {
          clearInterval(id);
          $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + site_pv)
          $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + site_uv)
          $("#busuanzi_value_page_pv").html(parseInt($("#busuanzi_value_page_pv").html()) + page_pv)
        }
      }
    </script>
    

  </div>
</footer>

<script type="text/javascript" src="/assets/js/backToTop.js"></script>
<img id="back-to-top" src="/assets/img/back-to-top.png" alt="back-to-top"></img>









<div id="wechat-widget">
  <p>
    Find me on WeChat with the ID <strong>EricTeo-</strong>, or scan my QR code:
  </p>

  <img src="/assets/img/wechat-qr-code.jpg" alt="QR code" id="qr-code" />
</div>



  <script type="text/javascript" src="/assets/js/vendor/retina-1.3.0.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/cash-4.1.5.min.js"></script>
<script type="text/javascript" src="/assets/js/site.js"></script>
</body>

</html>
